<div class="page-container no-print">
  
  <header class="page-header">
    <div>
      <h1>Or√ßamentos</h1>
      <p class="subtitle">Propostas comerciais e estimativas para clientes</p>
    </div>
    <button class="btn-primary" (click)="openModal()">
      <span class="icon">+</span> Novo Or√ßamento
    </button>
  </header>

  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        placeholder="Buscar por cliente, ve√≠culo ou N¬∫..."
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
      >
    </div>
  </div>

  <div class="table-container card">
    <table>
      <thead>
        <tr>
          <th>N¬∫</th>
          <th>Cliente / Ve√≠culo</th>
          <th>Validade</th>
          <th>Status</th>
          <th>Total</th>
          <th class="actions-col">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        @for (budget of filteredBudgets(); track budget.id) {
          <tr>
            <td><span class="budget-id">#{{ budget.id }}</span></td>
            <td>
              <div class="budget-info">
                <strong>{{ budget.client }}</strong>
                <span class="detail-text">{{ budget.vehicle }}</span>
              </div>
            </td>
            <td>{{ budget.validUntil | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="status-badge" [class]="budget.status">
                {{ getStatusLabel(budget.status) }}
              </span>
            </td>
            <td class="total-col">{{ budget.total | currency:'BRL' }}</td>
            <td class="actions-cell">
              
              <button class="btn-action view" (click)="viewBudget(budget)" title="Visualizar Detalhes">üëÅÔ∏è</button>
              
              @if (budget.status === 'approved') {
                  <button class="btn-action convert-to-os" (click)="convertToOS(budget)" title="Converter para Ordem de Servi√ßo">‚öôÔ∏è</button>
              }
              
              <button class="btn-action edit" (click)="editBudget(budget)">‚úèÔ∏è</button>
              <button class="btn-action delete" (click)="deleteBudget(budget.id)">üóëÔ∏è</button>
              <button class="btn-action print" (click)="printBudget(budget)" title="Imprimir">üñ®Ô∏è</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        
        <div class="modal-header">
          <h2>{{ currentBudget().id === 0 ? 'Novo Or√ßamento' : 'Editar Or√ßamento #' + currentBudget().id }}</h2>
          <div class="header-actions">
            @if (currentBudget().id !== 0) {
              <button type="button" class="btn-print" (click)="printBudget(currentBudget())">üñ®Ô∏è Imprimir</button>
            }
            <div class="total-display">
              Total: {{ currentBudget().total | currency:'BRL' }}
            </div>
          </div>
        </div>
        
        <form (ngSubmit)="saveBudget()">
          
          <div class="form-section">
            <div class="form-row">
              <div class="form-group col-4">
                <label>Cliente</label>
                <select [(ngModel)]="currentBudget().client" name="client" required (ngModelChange)="onClientChange(currentBudget().client)">
                  <option value="" disabled selected>Selecione...</option>
                  @for (c of clientsList(); track c) { <option [value]="c">{{ c }}</option> }
                </select>
              </div>
              <div class="form-group col-4">
                <label>Ve√≠culo</label>
                <select [(ngModel)]="currentBudget().vehicle" name="vehicle" required [disabled]="!currentBudget().client">
                  <option value="" disabled selected>Selecione...</option>
                  @for (v of availableVehicles(); track v) { <option [value]="v">{{ v }}</option> }
                </select>
              </div>
              <div class="form-group col-2">
                <label>Validade</label>
                <input type="date" [(ngModel)]="currentBudget().validUntil" name="validUntil">
              </div>
              <div class="form-group col-2">
                <label>Status</label>
                <select [(ngModel)]="currentBudget().status" name="status">
                  <option value="pending">Pendente</option>
                  <option value="approved">Aprovado</option>
                  <option value="rejected">Rejeitado</option>
                </select>
              </div>
            </div>
          </div>

          <div class="items-section">
            <h4>Adicionar Itens</h4>
            <div class="add-row">
              <div class="add-group service-group">
                <label>Adicionar Servi√ßo</label>
                <div class="input-with-btn">
                  <select [ngModel]="selectedServiceId()" (ngModelChange)="selectedServiceId.set($event)" name="addSvc">
                    <option [ngValue]="null">Selecione...</option>
                    @for (s of availableServices(); track s.id) {
                      <option [value]="s.id">{{ s.name }} ({{ s.price | currency:'BRL' }})</option>
                    }
                  </select>
                  <button type="button" class="btn-add" (click)="addService()">Add</button>
                </div>
              </div>

              <div class="add-group product-group">
                <label>Adicionar Pe√ßa</label>
                <div class="input-with-btn">
                  <select [ngModel]="selectedProductId()" (ngModelChange)="selectedProductId.set($event)" name="addProd">
                    <option [ngValue]="null">Selecione...</option>
                    @for (p of availableProducts(); track p.id) {
                      <option [value]="p.id">{{ p.name }} ({{ p.sellPrice | currency:'BRL' }})</option>
                    }
                  </select>
                  <input type="number" [ngModel]="productQty()" (ngModelChange)="productQty.set($event)" name="qty" class="qty-input" min="1" value="1">
                  <button type="button" class="btn-add" (click)="addProduct()">Add</button>
                </div>
              </div>
            </div>

            <h4>Itens do Or√ßamento</h4>
            <div class="items-list-container">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Descri√ß√£o</th>
                    <th>Qtd</th>
                    <th>Unit√°rio</th>
                    <th>Subtotal</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of currentBudget().items; track $index) {
                    <tr>
                      <td>
                        <span class="type-badge" [class]="item.type">
                          {{ item.type === 'service' ? 'Servi√ßo' : 'Pe√ßa' }}
                        </span>
                      </td>
                      <td>{{ item.name }}</td>
                      <td>{{ item.qty }}</td>
                      <td>{{ item.price | currency:'BRL' }}</td>
                      <td class="subtotal">{{ item.total | currency:'BRL' }}</td>
                      <td>
                        <button type="button" class="btn-remove-item" (click)="removeItem($index)">√ó</button>
                      </td>
                    </tr>
                  }
                  @if (currentBudget().items.length === 0) {
                    <tr><td colspan="6" class="empty-items">Nenhum item no or√ßamento.</td></tr>
                  }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="right"><strong>TOTAL GERAL:</strong></td>
                        <td class="subtotal right"><strong>{{ currentBudget().total | currency:'BRL' }}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="form-group">
            <label>Observa√ß√µes</label>
            <textarea [(ngModel)]="currentBudget().notes" name="notes" rows="2" placeholder="Condi√ß√µes de pagamento ou detalhes..."></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-save">Salvar Or√ßamento</button>
          </div>
        </form>
      </div>
    </div>
  }
  
  @if (showViewModal()) {
    <div class="modal-overlay" (click)="closeViewModal()">
      <div class="modal-content large-modal view-modal" (click)="$event.stopPropagation()">
        
        @if (budgetItemToView()) {
          <div class="modal-header">
            <h2>Or√ßamento #{{ budgetItemToView()!.id }} (Visualiza√ß√£o)</h2>
            <div class="header-actions">
              <div class="total-display">
                Total: {{ budgetItemToView()!.total | currency:'BRL' }}
              </div>
              <button type="button" class="btn-primary" (click)="printBudget(budgetItemToView()!)">üñ®Ô∏è Imprimir</button>
            </div>
          </div>
          
          <div class="read-only-details">
            <div class="form-row">
                <div class="form-group col-4">
                    <label>Cliente</label>
                    <p class="read-only-value"><strong>{{ budgetItemToView()!.client }}</strong></p>
                </div>
                <div class="form-group col-4">
                    <label>Ve√≠culo</label>
                    <p class="read-only-value"><strong>{{ budgetItemToView()!.vehicle }}</strong></p>
                </div>
                <div class="form-group col-2">
                    <label>Validade</label>
                    <p class="read-only-value">{{ budgetItemToView()!.validUntil | date:'dd/MM/yyyy' }}</p>
                </div>
                <div class="form-group col-2">
                    <label>Status</label>
                    <p class="read-only-value">
                        <span class="status-badge" [class]="budgetItemToView()!.status">
                            {{ getStatusLabel(budgetItemToView()!.status) }}
                        </span>
                    </p>
                </div>
            </div>
          </div>

          <div class="items-section read-only-items">
              <h4>Itens Inclu√≠dos</h4>
              <div class="items-list-container">
                <table class="items-table">
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Descri√ß√£o</th>
                      <th>Qtd</th>
                      <th>Unit√°rio</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of budgetItemToView()!.items; track $index) {
                      <tr>
                        <td>
                          <span class="type-badge" [class]="item.type">
                            {{ item.type === 'service' ? 'Servi√ßo' : 'Pe√ßa' }}
                          </span>
                        </td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.qty }}</td>
                        <td>{{ item.price | currency:'BRL' }}</td>
                        <td class="subtotal">{{ item.total | currency:'BRL' }}</td>
                      </tr>
                    }
                    @if (budgetItemToView()!.items.length === 0) {
                      <tr><td colspan="5" class="empty-items">Nenhum item no or√ßamento.</td></tr>
                    }
                  </tbody>
                  <tfoot>
                    <tr>
                        <td colspan="4" class="right"><strong>TOTAL GERAL:</strong></td>
                        <td class="subtotal right"><strong>{{ budgetItemToView()!.total | currency:'BRL' }}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
          </div>
          
          <div class="form-section read-only-notes">
              <label>Observa√ß√µes</label>
              <p class="read-only-value notes-text">{{ budgetItemToView()!.notes || 'Nenhuma observa√ß√£o registrada.' }}</p>
          </div>

          <div class="form-actions">
              <button type="button" class="btn-cancel" (click)="closeViewModal()">Fechar Visualiza√ß√£o</button>
          </div>
        }
      </div>
    </div>
  }
  
  <div class="printable-invoice" id="invoice">
    </div>
</div>