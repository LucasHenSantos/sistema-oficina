<div class="page-container">
  
  <header class="page-header">
    <div>
      <h1>Ordens de Servi√ßo</h1>
      <p class="subtitle">Controle de or√ßamentos, aprova√ß√µes e servi√ßos realizados</p>
    </div>
    <button class="btn-primary" (click)="openModal()">
      <span class="icon">+</span> Nova OS
    </button>
  </header>

  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        placeholder="Buscar por cliente, ve√≠culo ou N¬∫ da OS..."
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
      >
    </div>
  </div>

  <!-- TABELA PRINCIPAL -->
  <div class="table-container card">
    <table>
      <thead>
        <tr>
          <th>N¬∫ OS</th>
          <th>Cliente / Ve√≠culo</th>
          <th>Data</th>
          <th>Status</th>
          <th>Total</th>
          <th class="actions-col">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        @for (os of filteredOrders(); track os.id) {
          <tr>
            <td><span class="os-id">#{{ os.id }}</span></td>
            <td>
              <div class="os-info">
                <strong>{{ os.client }}</strong>
                <span class="detail-text">{{ os.vehicle }}</span>
              </div>
            </td>
            <td>{{ os.date | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="status-badge" [class]="os.status">
                {{ getStatusLabel(os.status) }}
              </span>
            </td>
            <td class="total-col">{{ os.total | currency:'BRL' }}</td>
            <td class="actions-cell">
              <button class="btn-action edit" (click)="editOrder(os)">‚úèÔ∏è</button>
              <button class="btn-action delete" (click)="deleteOrder(os.id)">üóëÔ∏è</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- MODAL DE OS -->
  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content large-modal" (click)="$event.stopPropagation()">
        
        <div class="modal-header">
          <h2>{{ currentOrder().id === 0 ? 'Nova Ordem de Servi√ßo' : 'Editar OS #' + currentOrder().id }}</h2>
          <div class="total-display">
            Total: {{ currentOrder().total | currency:'BRL' }}
          </div>
        </div>
        
        <form (ngSubmit)="saveOrder()">
          
          <!-- DADOS GERAIS -->
          <div class="form-section">
            <div class="form-row">
              <div class="form-group col-4">
                <label>Cliente</label>
                <select [(ngModel)]="currentOrder().client" name="client" required>
                  <option value="" disabled selected>Selecione...</option>
                  @for (c of clientsList(); track c) { <option [value]="c">{{ c }}</option> }
                </select>
              </div>
              <div class="form-group col-4">
                <label>Ve√≠culo</label>
                <select [(ngModel)]="currentOrder().vehicle" name="vehicle" required>
                  <option value="" disabled selected>Selecione...</option>
                  @for (v of vehiclesList(); track v) { <option [value]="v">{{ v }}</option> }
                </select>
              </div>
              <div class="form-group col-2">
                <label>Data</label>
                <input type="date" [(ngModel)]="currentOrder().date" name="date">
              </div>
              <div class="form-group col-2">
                <label>Status</label>
                <select [(ngModel)]="currentOrder().status" name="status">
                  <option value="pending">Pendente</option>
                  <option value="approved">Aprovado</option>
                  <option value="in-progress">Em Andamento</option>
                  <option value="completed">Finalizado</option>
                  <option value="canceled">Cancelado</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ADICIONAR ITENS (SERVI√áOS E PE√áAS) -->
          <div class="items-section">
            <div class="add-row">
              <!-- Adicionar Servi√ßo -->
              <div class="add-group service-group">
                <label>Adicionar Servi√ßo</label>
                <div class="input-with-btn">
                  <select [ngModel]="selectedServiceId()" (ngModelChange)="selectedServiceId.set($event)" name="addSvc">
                    <option [ngValue]="null">Selecione o servi√ßo...</option>
                    @for (s of availableServices(); track s.id) {
                      <option [value]="s.id">{{ s.name }} ({{ s.price | currency:'BRL' }})</option>
                    }
                  </select>
                  <button type="button" class="btn-add" (click)="addService()">Add</button>
                </div>
              </div>

              <!-- Adicionar Produto -->
              <div class="add-group product-group">
                <label>Adicionar Pe√ßa/Produto</label>
                <div class="input-with-btn">
                  <select [ngModel]="selectedProductId()" (ngModelChange)="selectedProductId.set($event)" name="addProd">
                    <option [ngValue]="null">Selecione a pe√ßa...</option>
                    @for (p of availableProducts(); track p.id) {
                      <option [value]="p.id">{{ p.name }} ({{ p.price | currency:'BRL' }})</option>
                    }
                  </select>
                  <input type="number" [ngModel]="productQty()" (ngModelChange)="productQty.set($event)" name="qty" class="qty-input" min="1" value="1">
                  <button type="button" class="btn-add" (click)="addProduct()">Add</button>
                </div>
              </div>
            </div>

            <!-- LISTA DE ITENS DA OS -->
            <div class="items-list-container">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Descri√ß√£o</th>
                    <th>Qtd</th>
                    <th>Unit√°rio</th>
                    <th>Subtotal</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of currentOrder().items; track $index) {
                    <tr>
                      <td>
                        <span class="type-badge" [class]="item.type">
                          {{ item.type === 'service' ? 'Servi√ßo' : 'Pe√ßa' }}
                        </span>
                      </td>
                      <td>{{ item.name }}</td>
                      <td>{{ item.qty }}</td>
                      <td>{{ item.price | currency:'BRL' }}</td>
                      <td class="subtotal">{{ item.total | currency:'BRL' }}</td>
                      <td>
                        <button type="button" class="btn-remove-item" (click)="removeItem($index)">√ó</button>
                      </td>
                    </tr>
                  }
                  @if (currentOrder().items.length === 0) {
                    <tr>
                      <td colspan="6" class="empty-items">Nenhum item adicionado √† OS.</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>

          <div class="form-group">
            <label>Observa√ß√µes / Diagn√≥stico</label>
            <textarea [(ngModel)]="currentOrder().notes" name="notes" rows="2" placeholder="Descreva o problema ou observa√ß√µes importantes..."></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-save">Salvar OS</button>
          </div>
        </form>
      </div>
    </div>
  }
</div>