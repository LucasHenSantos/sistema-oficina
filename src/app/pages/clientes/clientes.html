<div class="page-container">
  
  <header class="page-header">
    <div>
      <h1>Clientes</h1>
      <p class="subtitle">Gerencie contatos e hist√≥rico de atendimentos</p>
    </div>
    <button class="btn-primary" (click)="openModal()">
      <span class="icon">+</span> Novo Cliente
    </button>
  </header>

  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        placeholder="Buscar por nome ou telefone..."
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
      >
    </div>
  </div>

  <div class="table-container card">
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Ve√≠culos</th>
          <th>Contato</th>
          <th>Status</th>
          <th class="actions-col">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        @for (client of filteredClients(); track client.id) {
          <tr>
            <td class="client-info">
              <div class="avatar">{{ client.name.charAt(0) }}</div>
              <div class="text-data">
                <strong>{{ client.name }}</strong>
                <span class="id-text">{{ client.email }}</span>
              </div>
            </td>
            <td>
              <div class="cars-list">
                @for (car of client.associatedVehicles; track car) {
                  <span class="car-badge">{{ car }}</span>
                }
                @if (!client.associatedVehicles || client.associatedVehicles.length === 0) { 
                  <span class="no-car">Sem ve√≠culo</span> 
                }
              </div>
            </td>
            <td>{{ client.phone }}</td>
            <td>
              <span class="status-badge" [class]="client.status">{{ client.statusLabel }}</span>
            </td>
            <td class="actions-cell">
              <button class="btn-action view" (click)="viewClient(client.name)" title="Visualizar Detalhes">üëÅÔ∏è</button>
              
              <button class="btn-action edit" (click)="editClient(client)">‚úèÔ∏è</button>
              <button class="btn-action delete" (click)="deleteClient(client.id)">üóëÔ∏è</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>{{ currentClient().id === 0 ? 'Novo Cliente' : 'Editar Cliente' }}</h2>
        
        <form (ngSubmit)="saveClient()" #clientForm="ngForm">
          
          <div class="form-group">
            <label>Nome Completo *</label>
            <input type="text" [(ngModel)]="currentClient().name" name="name" required minlength="3" placeholder="Ex: Jo√£o da Silva">
          </div>

          <div class="form-row">
            <div class="form-group col-6">
              <label>Telefone / WhatsApp *</label>
              <input type="text" [(ngModel)]="currentClient().phone" name="phone" required minlength="8" placeholder="(00) 00000-0000">
            </div>
            <div class="form-group col-6">
              <label>E-mail (Opcional)</label>
              <input type="email" [(ngModel)]="currentClient().email" name="email" placeholder="cliente@email.com">
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-save">Salvar Cliente</button>
          </div>
        </form>
      </div>
    </div>
  }
  
  @if (showViewModal()) {
    <div class="modal-overlay" (click)="closeViewModal()">
      <div class="modal-content large-modal view-modal" (click)="$event.stopPropagation()">
        
        @if (clientDetails()) {
          <h2>Detalhes do Cliente: {{ clientDetails().client.name }}</h2>
          
          <div class="client-view-details">
            <div class="detail-group">
                <h4>Contato e Status</h4>
                <p><strong>Telefone:</strong> {{ clientDetails().client.phone }}</p>
                <p><strong>E-mail:</strong> {{ clientDetails().client.email }}</p>
                <p><strong>Status:</strong> <span class="status-badge" [class]="clientDetails().client.status">{{ clientDetails().client.statusLabel }}</span></p>
                <p><strong>√öltima Visita:</strong> {{ clientDetails().client.lastVisit | date:'dd/MM/yyyy' }}</p>
            </div>

            <div class="detail-group vehicles-group">
                <h4>Ve√≠culos Vinculados (Total: {{ clientDetails().vehicles.length }})</h4>
                
                @if (clientDetails().vehicles.length > 0) {
                    <ul class="vehicle-list-view">
                        @for (v of clientDetails().vehicles; track v.id) {
                            <li>
                                <strong>{{ v.plate }}</strong> - {{ v.brand }} {{ v.model }} ({{ v.year }})
                            </li>
                        }
                    </ul>
                } @else {
                    <p class="no-veiculo">Nenhum ve√≠culo cadastrado para este cliente.</p>
                }
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeViewModal()">Fechar</button>
            <button type="button" class="btn-save" (click)="editClient(clientDetails().client)">‚úèÔ∏è Editar Cliente</button>
          </div>
        }
      </div>
    </div>
  }
</div>